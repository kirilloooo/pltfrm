<?php
include_once __DIR__ . "/../includes/settings.php";

if (isset($_GET["id"])) {$file_id = $_GET["id"];
}

$stmt = $conn->prepare("SELECT * FROM files WHERE file_id = :file_id");
$stmt->execute([":file_id" => $file_id]);
$file = $stmt->fetch(PDO::FETCH_ASSOC);

// Assuming you have the $file['user_id'] available
$user_id = $file['user_id'];

// Fetch user's plan details from the database
$stmt = $conn->prepare('SELECT delete_time FROM plans WHERE id IN (SELECT owner_plan FROM files WHERE file_id = :file_id)');
$stmt->execute(array(':file_id' => $file_id));
$user_plan = $stmt->fetch(PDO::FETCH_ASSOC);

// Check if the plan details were fetched successfully
if ($user_plan) {$delete_time = $user_plan['delete_time'];// Calculate the deletion date based on the user's plan$deletionDate = $file['date'] + $delete_time;// Now, use $deletionDate in your JavaScript to update the timer
} else {// Handle the case where the user's plan details were not found
}

?>

<!DOCTYPE html>
<html lang="en">

<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" /><meta name="format-detection" content="telephone=no" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta name="MobileOptimized" content="176" /><meta name="HandheldFriendly" content="True" /><script src="https://telegram.org/js/telegram-web-app.js"></script><meta name="robots" content="noindex,nofollow" /><title>File Download Page</title><style>    body {        display: flex;        justify-content: center;        align-items: center;        height: 100vh;        margin: 0;        font-family: Arial, sans-serif;        background-color: var(--tg-theme-bg-color);        color: var(--tg-theme-text-color);        flex-direction: column;     }
    .main-container {        text-align: center;        background-color: var(--tg-theme-secondary-bg-color);        padding: 20px;        border-radius: 8px;        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);        width: 300px;    }
    .file-preview {        width: auto;        max-height: 222px;    }
    .file-preview img, .file-preview audio, .file-preview video {        max-width: 250px;        max-height: 200px;    }    
    .download-btn {        text-align: center;        display: inline-block;        padding: 10px 20px;        background-color: var(--tg-theme-hint-color);        color: var(--tg-theme-button-text-color);        text-decoration: none;        border-radius: 8px;        transition: background-color 0.3s ease;        margin-top: 20px;        width: 300px;    }
    .download-btn:hover {        background-color: var(--tg-theme-button-color);        color: var(--tg-theme-button-text-color);    }        p {        color: var(--tg-theme-hint-color);        margin: 0px;    }        .title{        color: var(--tg-theme-text-color);        margin: 10px;    }        #previewButton {        color: var(--tg-theme-link-color);        margin: 10px;    }        .alert{position:relative;padding:.75rem 1.25rem;margin-bottom:1rem;border:1px solid transparent;border-radius:.25rem}.alert-heading{color:inherit}.alert-link{font-weight:700}.alert-dismissible{padding-right:4rem}.alert-dismissible .close{position:absolute;top:0;right:0;padding:.75rem 1.25rem;color:inherit}.alert-primary{color:#004085;background-color:#cce5ff;border-color:#b8daff}.alert-primary hr{border-top-color:#9fcdff}.alert-primary .alert-link{color:#002752}.alert-secondary{color:#383d41;background-color:#e2e3e5;border-color:#d6d8db}.alert-secondary hr{border-top-color:#c8cbcf}.alert-secondary .alert-link{color:#202326}.alert-success{color:#155724;background-color:#d4edda;border-color:#c3e6cb}.alert-success hr{border-top-color:#b1dfbb}.alert-success .alert-link{color:#0b2e13}.alert-info{color:#0c5460;background-color:#d1ecf1;border-color:#bee5eb}.alert-info hr{border-top-color:#abdde5}.alert-info .alert-link{color:#062c33}.alert-warning{color:#856404;background-color:#fff3cd;border-color:#ffeeba}.alert-warning hr{border-top-color:#ffe8a1}.alert-warning .alert-link{color:#533f03}.alert-danger{color:#721c24;background-color:#f8d7da;border-color:#f5c6cb}.alert-danger hr{border-top-color:#f1b0b7}.alert-danger .alert-link{color:#491217}.alert-light{color:#818182;background-color:#fefefe;border-color:#fdfdfe}.alert-light hr{border-top-color:#ececf6}.alert-light .alert-link{color:#686868}.alert-dark{color:#1b1e21;background-color:#d6d8d9;border-color:#c6c8ca}.alert-dark hr{border-top-color:#b9bbbe}.alert-dark .alert-link{color:#040505}</style>
</head>

<body><img style="height: 100px; width: 100px; margin-bottom: 25px;" src="/data/img/animatedemojies_agadrgmaaiqhguq.webp">    <div class="main-container">            <?php if ($file): ?>        <div>            <p class="title"><strong><?php echo $file[                "file_rename"            ]; ?></strong></p>            <p>ID: <strong><?php echo $file["origin_file_id"]; ?></strong></p>            <p>Size: <strong><?php            $fileSizeInBits = $file["file_size"];
            if ($fileSizeInBits < 1048576) {                $fileSizeInKilobytes = $fileSizeInBits / 1024; // 1,024 bits = 1 KB                $fileSizeInKilobytesRounded = round(                    $fileSizeInKilobytes,                    2                ); // Rounded to two decimal places
                if ($fileSizeInKilobytes < 1) {                    echo $fileSizeInBits . " bytes";                } else {                    echo $fileSizeInKilobytesRounded . " KB";                }            } else {                $fileSizeInMegabytes = $fileSizeInBits / 1048576; // 1,048,576 bits = 1 MB                $fileSizeInMegabytesRounded = round(                    $fileSizeInMegabytes,                    2                ); // Rounded to two decimal places
                echo $fileSizeInMegabytesRounded . " MB";            }            ?></strong></p>            <p>Pre-deletion: <strong id="timer">6d 23h 59m 59s</strong></p>                                    <p class="card-text">                        <?php                        // Получение даты загрузки файла из временной метки (timestamp)                        $uploadDate = $file["date"]; // Предположим, что это временная метка UNIX
                        // Преобразуем временные метки в формат Y-m-d для использования в запросе к API                        $fromDate = date("Y-m-d", $uploadDate);                        $toDate = date("Y-m-d", $deletionDate);
                        // Создаем URL запроса к API с учетом временного интервала                        $api_url = "https://fy.oo.gd/api/v1/stats/10?name=page&per_page=100&from=$fromDate&to=$toDate";
                        $api_key =                            "WKDRKItubVZNcTWirjvlDnD4F8N5iXVOQHlPtqasb7RjUCIh8xGKuoDet1DOQhDB"; // Замените YOUR_API_KEY на ваш API ключ
                        $ch = curl_init($api_url);                        curl_setopt($ch, CURLOPT_HTTPHEADER, [                            "Accept: application/json",                            "Authorization: Bearer " . $api_key,                        ]);                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);                        $response = curl_exec($ch);
                        if (curl_getinfo($ch, CURLINFO_HTTP_CODE) === 200) {                            $data = json_decode($response, true);
                            // Обработка данных: просмотры для данного файла                            $file_views = 0;                            foreach ($data["data"] as $item) {                                if (                                    $item["value"] ===                                    "/preview?id=" . $file_id                                ) {                                    $file_views = $item["count"];                                    break;                                }                            }
                            // Отображение количества просмотров на странице                            echo "File Views: <strong>$file_views</strong>";                        } else {                            echo "Failed to fetch views data.";                        }                        ?>                    </p>
                    <p id="previewButton" style="cursor: pointer;">Show preview</p>                    <div class="file-preview" id="previewContainer" style="display: none;">                                                <?php                                                $fileType = pathinfo(                                                    strtolower(                                                        $file["file_name"]                                                    ),                                                    PATHINFO_EXTENSION                                                );                                                if (                                                    in_array($fileType, [                                                        "jpg",                                                        "jpeg",                                                        "png",                                                        "gif",                                                        "svg",                                                        "webp",                                                        "avif",                                                        "apng",                                                        "ico",                                                    ])                                                ) {                                                    echo '<img class="thumbnail-image img-fluid" src="site.com' .                                                        $file["file_dir"] .                                                        "/" .                                                        $file["file_name"] .                                                        '" alt="File Preview">';                                                } elseif (                                                    in_array($fileType, [                                                        "mp4",                                                        "mov",                                                        "ogg",                                                        "webm",                                                        "mkv",                                                        "flv",                                                        "avi",                                                        "m4v",                                                    ])                                                ) {                                                    echo '<video controls>                        <source src="site.com' .                                                        $file["file_dir"] .                                                        "/" .                                                        $file["file_name"] .                                                        '"alt="File Preview">                          <div class="alert alert-warning" role="alert">Your browser does not support the video preview.</div>                          </video>';                                                } elseif (                                                    in_array($fileType, [                                                        "m4a",                                                        "flac",                                                        "mp3",                                                        "wav",                                                        "aac",                                                        "wma",                                                    ])                                                ) {                                                    echo '<audio controls>                        <source src="site.com' .                                                        $file["file_dir"] .                                                        "/" .                                                        $file["file_name"] .                                                        '" alt="File Preview">                          <div class="alert alert-warning" role="alert">Your browser does not support the video preview.</div>                          </audio>';                                                } else {                                                    // Handle other file types (videos, documents, etc.) as needed                                                    echo '<div class="alert alert-warning" role="alert">Preview not available for this file type.</div>';                                                }                                                ?>                    </div></div></div>                    <a onclick="window.Telegram.WebApp.openLink('https://site.com/file?id=<?php echo $file[                        "file_id"                    ]; ?>')" class="download-btn" download>Open In Browser</a>
    <?php else: ?>        <div class="alert alert-danger" role="alert">            File not found.        </div>    <?php endif; ?>

<script>    // Функция для обновления таймера    function updateTimer() {        var deletionDate = <?php echo $deletionDate; ?>;        var now = Math.floor(Date.now() / 1000); // Текущее время в секундах
        var timeLeft = deletionDate - now;        if (timeLeft > 0) {            var days = Math.floor(timeLeft / (60 * 60 * 24));            var hours = Math.floor((timeLeft % (60 * 60 * 24)) / (60 * 60));            var minutes = Math.floor((timeLeft % (60 * 60)) / 60);            var seconds = Math.floor(timeLeft % 60);
            document.getElementById('timer').innerHTML = days + "d " + hours + "h " + minutes + "m " + seconds + "s";        } else {            document.getElementById('timer').innerHTML = "File has been deleted";        }    }
    // Обновляем таймер каждую секунду    setInterval(updateTimer, 1000);</script>
<script>document.getElementById('previewButton').addEventListener('click', function() {    var previewContainer = document.getElementById('previewContainer');    var filePreview = document.querySelector('.file-preview');
    // Определение типа файла    var fileType = '<?php echo $fileType; ?>';
    // Определяем, поддерживается ли предпросмотр для данного типа файла    var supportedTypes = ['jpg', 'ico', 'jpeg', 'png', 'gif', 'svg', 'webp', 'avif', 'apng', 'mp4', 'mov', 'ogg', 'webm', 'mkv', 'flv', 'avi', 'm4v', 'm4a', 'flac', 'mp3', 'wav', 'aac', 'wma'];
    if (supportedTypes.includes(fileType)) {        if (previewContainer.style.display === 'none') {            filePreview.style.display = 'none'; // Скрыть основной блок предпросмотра файла            previewContainer.style.display = 'block'; // Показать блок предпросмотра            document.getElementById('previewButton').textContent = 'Hide preview'; // Изменить текст кнопки        } else {            previewContainer.style.display = 'none'; // Скрыть блок предпросмотра            document.getElementById('previewButton').textContent = 'Show preview'; // Изменить текст кнопки        }    } else {        // Если предпросмотр не поддерживается для данного типа файла        alert('Preview is not available for this file type');    }});
</script>

</body>

</html>